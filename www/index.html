<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoicePrompter - è¯­éŸ³æè¯å™¨</title>
    
    <!-- Capacitor Native Support -->
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#ff6b9d">
    <meta name="description" content="è‡ªåª’ä½“åšä¸»å¿…å¤‡çš„æè¯å™¨å·¥å…·ï¼Œæ”¯æŒè¯­éŸ³è·Ÿè¸ªå’Œè‡ªåŠ¨æ»šåŠ¨">
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æè¯å™¨">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
        }
        
        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            z-index: 100;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        .settings-panel.hidden {
            transform: translateY(100%);
        }
        
        .settings-panel h1 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 20px;
            color: #ff6b9d;
        }
        
        .settings-panel h1 span {
            font-size: 32px;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ff6b9d;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            resize: vertical;
            margin-bottom: 20px;
        }
        
        textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            font-size: 16px;
            margin-bottom: 8px;
            color: #ff6b9d;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255,107,157,0.3);
            border-radius: 4px;
            outline: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #ff6b9d;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .value-display {
            text-align: center;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-top: 5px;
        }
        
        .toggle-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .toggle-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: 2px solid #ff6b9d;
            background: transparent;
            color: #fff;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #ff6b9d;
        }
        
        .toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .start-btn {
            width: 100%;
            padding: 18px;
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none;
            border-radius: 30px;
            color: #fff;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255,107,157,0.4);
        }
        
        .feature-note {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 5px;
        }
        
        /* æè¯å™¨ç•Œé¢ */
        .teleprompter {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            background: #000;
        }
        
        .teleprompter.active {
            display: flex;
        }
        
        .prompter-text {
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .text-content {
            text-align: center;
            line-height: 1.8;
            transition: transform 0.15s ease-out;
        }
        
        /* mirrored class removed - handled by JS transform */
        
        .text-content p {
            margin: 0.5em 0;
            transition: all 0.3s;
        }
        
        .text-content p.current {
            color: #ff6b9d;
            text-shadow: 0 0 20px rgba(255,107,157,0.5);
        }
        
        .text-content p.spoken {
            opacity: 0.4;
        }
        
        /* ä¸­å¿ƒæŒ‡ç¤ºçº¿ */
        .center-line {
            position: fixed;
            left: 0;
            right: 0;
            top: 50%;
            height: 3px;
            background: rgba(255,107,157,0.5);
            pointer-events: none;
            z-index: 10;
        }
        
        /* æ¸å˜é®ç½© */
        .fade-top, .fade-bottom {
            position: fixed;
            left: 0;
            right: 0;
            height: 100px;
            pointer-events: none;
            z-index: 5;
        }
        
        .fade-top {
            top: 0;
            background: linear-gradient(to bottom, #000 0%, transparent 100%);
        }
        
        .fade-bottom {
            bottom: 60px;
            background: linear-gradient(to top, #000 0%, transparent 100%);
        }
        
        /* è¯­éŸ³çŠ¶æ€æŒ‡ç¤º */
        .voice-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 12px 20px;
            background: rgba(76, 175, 80, 0.95);
            border-radius: 12px;
            font-size: 16px;
            z-index: 30;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .voice-indicator.active {
            display: flex;
        }
        
        .voice-indicator .mic-icon {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .voice-indicator .heard-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 14px;
        }
        
        /* æ§åˆ¶æ  */
        .control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            z-index: 20;
        }
        
        .ctrl-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ctrl-btn.play {
            width: 60px;
            height: 60px;
            background: #ff6b9d;
            font-size: 28px;
        }
        
        .ctrl-btn.voice-active {
            background: #4CAF50;
            animation: pulse 1s infinite;
        }
        
        .speed-adjust {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            font-size: 14px;
        }
        
        .speed-adjust button {
            width: 36px;
            height: 36px;
            border: 2px solid #ff6b9d;
            background: transparent;
            color: #fff;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: var(--accent-color, #ff6b9d);
            z-index: 25;
            transition: width 0.1s linear;
        }
        
        /* è®¡æ—¶å™¨æ˜¾ç¤º */
        .timer-display {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            z-index: 25;
        }
        
        /* ä¸»é¢˜å˜é‡ */
        :root {
            --bg-color: #000;
            --text-color: #fff;
            --accent-color: #ff6b9d;
            --secondary-bg: #1a1a2e;
        }
        
        /* ä¸»é¢˜: Classic (é»˜è®¤é»‘åº•ç™½å­—) */
        body.theme-classic {
            --bg-color: #000;
            --text-color: #fff;
            --accent-color: #ff6b9d;
        }
        
        /* ä¸»é¢˜: Light (ç™½åº•é»‘å­—) */
        body.theme-light {
            --bg-color: #f5f5f5;
            --text-color: #1a1a1a;
            --accent-color: #e91e63;
            --secondary-bg: #ffffff;
        }
        body.theme-light .teleprompter { background: var(--bg-color); }
        body.theme-light .text-content { color: var(--text-color); }
        body.theme-light .fade-top { background: linear-gradient(to bottom, var(--bg-color) 0%, transparent 100%); }
        body.theme-light .fade-bottom { background: linear-gradient(to top, var(--bg-color) 0%, transparent 100%); }
        
        /* ä¸»é¢˜: Midnight Blue */
        body.theme-midnight {
            --bg-color: #0a1628;
            --text-color: #e0e7ff;
            --accent-color: #60a5fa;
        }
        body.theme-midnight .teleprompter { background: var(--bg-color); }
        body.theme-midnight .fade-top { background: linear-gradient(to bottom, var(--bg-color) 0%, transparent 100%); }
        body.theme-midnight .fade-bottom { background: linear-gradient(to top, var(--bg-color) 0%, transparent 100%); }
        
        /* ä¸»é¢˜: Forest Green */
        body.theme-forest {
            --bg-color: #0d1f0d;
            --text-color: #d4edda;
            --accent-color: #4caf50;
        }
        body.theme-forest .teleprompter { background: var(--bg-color); }
        body.theme-forest .fade-top { background: linear-gradient(to bottom, var(--bg-color) 0%, transparent 100%); }
        body.theme-forest .fade-bottom { background: linear-gradient(to top, var(--bg-color) 0%, transparent 100%); }
        
        /* ä¸»é¢˜: Sunset Orange */
        body.theme-sunset {
            --bg-color: #1a0a00;
            --text-color: #ffe4c4;
            --accent-color: #ff7043;
        }
        body.theme-sunset .teleprompter { background: var(--bg-color); }
        body.theme-sunset .fade-top { background: linear-gradient(to bottom, var(--bg-color) 0%, transparent 100%); }
        body.theme-sunset .fade-bottom { background: linear-gradient(to top, var(--bg-color) 0%, transparent 100%); }
        
        /* ä¸»é¢˜: Ocean */
        body.theme-ocean {
            --bg-color: #001a33;
            --text-color: #b3e0ff;
            --accent-color: #00bcd4;
        }
        body.theme-ocean .teleprompter { background: var(--bg-color); }
        body.theme-ocean .fade-top { background: linear-gradient(to bottom, var(--bg-color) 0%, transparent 100%); }
        body.theme-ocean .fade-bottom { background: linear-gradient(to top, var(--bg-color) 0%, transparent 100%); }
        
        /* ä¸»é¢˜: Purple */
        body.theme-purple {
            --bg-color: #1a0033;
            --text-color: #e6ccff;
            --accent-color: #9c27b0;
        }
        body.theme-purple .teleprompter { background: var(--bg-color); }
        body.theme-purple .fade-top { background: linear-gradient(to bottom, var(--bg-color) 0%, transparent 100%); }
        body.theme-purple .fade-bottom { background: linear-gradient(to top, var(--bg-color) 0%, transparent 100%); }
        
        /* åº”ç”¨ä¸»é¢˜è‰²åˆ°é«˜äº®è¡Œ */
        .text-content p.current {
            color: var(--accent-color, #ff6b9d);
            text-shadow: 0 0 20px color-mix(in srgb, var(--accent-color) 50%, transparent);
        }
        
        /* ä¸­å¿ƒçº¿ä½¿ç”¨ä¸»é¢˜è‰² */
        .center-line {
            background: color-mix(in srgb, var(--accent-color) 50%, transparent) !important;
        }
        
        /* å€’è®¡æ—¶ */
        .countdown {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            font-weight: bold;
            color: #ff6b9d;
            z-index: 200;
        }
        
        .countdown.active {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <h1><span>ğŸ“œ</span> æè¯å™¨</h1>
        
        <div style="position: relative;">
            <textarea id="scriptText" placeholder="åœ¨è¿™é‡Œç²˜è´´ä½ çš„æ–‡æ¡ˆ...&#10;&#10;æ”¯æŒå¤šæ®µè½ï¼Œæ»šåŠ¨æ’­æ”¾æ—¶ä¼šè‡ªåŠ¨å±…ä¸­æ˜¾ç¤ºã€‚">å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„å°çº¢ä¹¦ï¼

ä»Šå¤©æƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸ªè¶…çº§å®ç”¨çš„æŠ€å·§ã€‚

å¾ˆå¤šå°ä¼™ä¼´é—®æˆ‘ï¼Œæ‹è§†é¢‘çš„æ—¶å€™æ€»æ˜¯å¿˜è¯æ€ä¹ˆåŠï¼Ÿ

å…¶å®å¾ˆç®€å•ï¼Œç”¨æè¯å™¨å°±å¯ä»¥å•¦ï¼

åƒæˆ‘ç°åœ¨å°±æ˜¯ä¸€è¾¹çœ‹ç€æè¯å™¨ï¼Œä¸€è¾¹å½•è§†é¢‘ã€‚

è¿™æ ·å°±ä¸ç”¨æ‹…å¿ƒå¿˜è¯äº†ï¼Œè€Œä¸”è¯­é€Ÿä¹Ÿå¯ä»¥æ§åˆ¶å¾—å¾ˆç¨³å®šã€‚

å¥½å•¦ï¼Œä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™é‡Œã€‚

å¦‚æœè§‰å¾—æœ‰ç”¨çš„è¯ï¼Œè®°å¾—ç‚¹èµæ”¶è—å“¦ï¼

æˆ‘ä»¬ä¸‹æœŸå†è§ï¼Œæ‹œæ‹œï½ ğŸ‘‹</textarea>
            <button id="clearBtn" style="position: absolute; top: 10px; right: 10px; background: rgba(255,107,157,0.8); border: none; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 14px; cursor: pointer;">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        
        <div class="control-group">
            <label>ğŸ“ å­—ä½“å¤§å°</label>
            <input type="range" id="fontSize" min="24" max="72" value="42">
            <div class="value-display" id="fontSizeValue">42px</div>
        </div>
        
        <div class="control-group">
            <label>ğŸ¤ æ»šåŠ¨æ¨¡å¼</label>
            <div class="toggle-group">
                <button class="toggle-btn active" data-scroll-mode="auto">è‡ªåŠ¨æ»šåŠ¨</button>
                <button class="toggle-btn" data-scroll-mode="voice" id="voiceModeBtn">è¯­éŸ³è·Ÿè¸ª</button>
            </div>
            <div class="feature-note" id="voiceNote">è¯­éŸ³è·Ÿè¸ªï¼šæ ¹æ®ä½ è¯´çš„è¯è‡ªåŠ¨æ»šåŠ¨ï¼ˆéœ€è¦éº¦å…‹é£æƒé™ï¼‰<br>âš ï¸ è¯·åœ¨ Safari/Chrome ä¸­æ‰“å¼€ï¼Œå¾®ä¿¡/Telegram å†…ç½®æµè§ˆå™¨ä¸æ”¯æŒ</div>
        </div>
        
        <div class="control-group" id="speedControl">
            <label>ğŸš€ æ»šåŠ¨é€Ÿåº¦</label>
            <input type="range" id="scrollSpeed" min="10" max="100" value="40">
            <div class="value-display" id="speedValue">40</div>
        </div>
        
        <div class="control-group">
            <label>â±ï¸ å¼€å§‹å€’è®¡æ—¶</label>
            <div class="toggle-group">
                <button class="toggle-btn" data-countdown="0">æ— </button>
                <button class="toggle-btn active" data-countdown="3">3ç§’</button>
                <button class="toggle-btn" data-countdown="5">5ç§’</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>ğŸ“¹ ç›¸æœºæ¨¡å¼ï¼ˆè¾¹çœ‹è¯è¾¹å½•åƒï¼‰</label>
            <div class="toggle-group">
                <button class="toggle-btn active" data-camera="false">å…³é—­</button>
                <button class="toggle-btn" data-camera="true">å¼€å¯</button>
            </div>
            <div class="feature-note">å¼€å¯åæ–‡å­—ä¼šå åŠ åœ¨ç›¸æœºç”»é¢ä¸Šï¼Œæ–¹ä¾¿è¾¹çœ‹è¯è¾¹å½•åƒ</div>
        </div>
        
        <div class="control-group">
            <label>ğŸª é•œåƒæ¨¡å¼ï¼ˆé…åˆé•œå­ä½¿ç”¨ï¼‰</label>
            <div class="toggle-group">
                <button class="toggle-btn active" data-mirror="false">æ­£å¸¸</button>
                <button class="toggle-btn" data-mirror="true">é•œåƒ</button>
            </div>
        </div>
        
        <button class="start-btn" id="startBtn">â–¶ï¸ å¼€å§‹æè¯</button>
    </div>
    
    <!-- æè¯å™¨ç•Œé¢ -->
    <div class="teleprompter" id="teleprompter">
        <!-- ç›¸æœºé¢„è§ˆ -->
        <video id="cameraPreview" autoplay playsinline muted style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1;"></video>
        
        <!-- å½•åˆ¶ç”¨çš„ Canvasï¼ˆéšè—ï¼‰-->
        <canvas id="recordCanvas" style="display:none;"></canvas>
        
        <!-- å½•åˆ¶æŒ‡ç¤ºå™¨ -->
        <div id="recordIndicator" style="display:none; position:fixed; top:20px; left:20px; background:red; color:white; padding:8px 16px; border-radius:20px; font-size:14px; z-index:100; animation: blink 1s infinite;">
            ğŸ”´ å½•åˆ¶ä¸­...
        </div>
        
        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        
        <!-- è®¡æ—¶å™¨ -->
        <div class="timer-display" id="timerDisplay">00:00</div>
        
        <!-- è°ƒè¯•é¢æ¿ -->
        <div id="debugPanel" style="position:fixed; bottom:100px; left:10px; right:10px; background:rgba(0,0,0,0.9); color:#0f0; font-family:monospace; font-size:11px; padding:8px; border-radius:8px; max-height:150px; overflow-y:auto; z-index:999; display:none;">
            <div id="debugLog"></div>
        </div>
        
        <div class="fade-top"></div>
        <div class="center-line"></div>
        
        <!-- è¯­éŸ³çŠ¶æ€æŒ‡ç¤º -->
        <div class="voice-indicator" id="voiceIndicator">
            <span class="mic-icon">ğŸ¤</span>
            <span class="heard-text" id="heardText">å¬åˆ°: ...</span>
        </div>
        
        <div class="prompter-text">
            <div class="text-content" id="textContent"></div>
        </div>
        <div class="fade-bottom"></div>
        
        <div class="control-bar">
            <button class="ctrl-btn" id="backBtn">â¬…ï¸</button>
            <div class="speed-adjust" id="speedAdjustBar">
                <button id="speedDown">âˆ’</button>
                <span id="currentSpeed">40</span>
                <button id="speedUp">+</button>
            </div>
            <button class="ctrl-btn play" id="playPauseBtn">â¸ï¸</button>
            <button class="ctrl-btn" id="voiceBtn" style="display:none;">ğŸ¤</button>
            <button class="ctrl-btn" id="recordBtn" style="display:none; background:#ff4444;">âº</button>
            <button class="ctrl-btn" id="resetBtn">â†º</button>
            <button class="ctrl-btn" id="exitBtn">âœ•</button>
        </div>
    </div>
    
    <!-- å€’è®¡æ—¶ -->
    <div class="countdown" id="countdown"></div>
    
    <script>
        // çŠ¶æ€
        let isPlaying = false;
        let scrollPosition = 0;
        let speed = 40;
        let fontSize = 42;
        let countdownSeconds = 3;
        let isMirrored = false;
        let animationId = null;
        let scrollMode = 'auto'; // 'auto' or 'voice'
        let cameraEnabled = false;
        let cameraStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let canvasStream = null;
        let recordingAnimationId = null;
        let currentTheme = 'classic';
        let startTime = null;
        let wakeLock = null;
        
        // ä¸»é¢˜åˆ—è¡¨
        const themes = ['classic', 'light', 'midnight', 'forest', 'sunset', 'ocean', 'purple'];
        const themeNames = {
            classic: 'ç»å…¸é»‘',
            light: 'æ˜äº®ç™½',
            midnight: 'åˆå¤œè“',
            forest: 'æ£®æ—ç»¿',
            sunset: 'æ—¥è½æ©™',
            ocean: 'æµ·æ´‹è“',
            purple: 'ç¥ç§˜ç´«'
        };
        
        // è¯­éŸ³è¯†åˆ«ç›¸å…³
        let recognition = null;
        let isVoiceActive = false;
        let scriptLines = [];
        let currentLineIndex = 0;
        let allText = '';
        
        // æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ”¯æŒ
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speechSupported = !!SpeechRecognition;
        
        // å…ƒç´ 
        const settingsPanel = document.getElementById('settingsPanel');
        const teleprompter = document.getElementById('teleprompter');
        const textContent = document.getElementById('textContent');
        const countdown = document.getElementById('countdown');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const currentSpeedEl = document.getElementById('currentSpeed');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const heardText = document.getElementById('heardText');
        const voiceBtn = document.getElementById('voiceBtn');
        const speedAdjustBar = document.getElementById('speedAdjustBar');
        const speedControl = document.getElementById('speedControl');
        const voiceModeBtn = document.getElementById('voiceModeBtn');
        const voiceNote = document.getElementById('voiceNote');
        
        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        if (speechSupported) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;  // è·å–ä¸­é—´ç»“æœï¼Œæ›´å¿«å“åº”
            recognition.maxAlternatives = 1;
            recognition.lang = 'zh-CN';
            
            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                
                // æ˜¾ç¤ºè¯†åˆ«åˆ°çš„æ–‡å­—
                heardText.textContent = 'å¬åˆ°: ' + transcript.slice(-30);
                console.log('è¯†åˆ«åˆ°:', transcript);
                
                // æ¨¡ç³ŠåŒ¹é…æ‰¾åˆ°å½“å‰ä½ç½®
                findAndScrollToPosition(transcript);
            };
            
            recognition.onstart = () => {
                console.log('è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨');
                heardText.textContent = 'ğŸ¤ æ­£åœ¨å¬... è¯·å¼€å§‹è¯´è¯';
            };
            
            recognition.onaudiostart = () => {
                console.log('æ£€æµ‹åˆ°éŸ³é¢‘è¾“å…¥');
                heardText.textContent = 'ğŸ¤ æ£€æµ‹åˆ°å£°éŸ³...';
            };
            
            recognition.onspeechstart = () => {
                console.log('æ£€æµ‹åˆ°è¯­éŸ³');
                heardText.textContent = 'ğŸ¤ æ­£åœ¨è¯†åˆ«...';
            };
            
            recognition.onerror = (event) => {
                console.log('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                if (event.error === 'not-allowed') {
                    alert('è¯·å…è®¸éº¦å…‹é£æƒé™ä»¥ä½¿ç”¨è¯­éŸ³è·Ÿè¸ªåŠŸèƒ½');
                    stopVoiceRecognition();
                }
            };
            
            recognition.onend = () => {
                console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');
                // å¦‚æœè¿˜åœ¨è¯­éŸ³æ¨¡å¼ï¼Œè‡ªåŠ¨é‡å¯
                if (isVoiceActive && scrollMode === 'voice') {
                    heardText.textContent = 'é‡æ–°è¿æ¥ä¸­...';
                    setTimeout(() => {
                        try {
                            recognition.start();
                            console.log('é‡æ–°å¯åŠ¨è¯­éŸ³è¯†åˆ«');
                        } catch(e) {
                            console.log('é‡å¯å¤±è´¥:', e);
                        }
                    }, 100);
                }
            };
            
            recognition.onnomatch = () => {
                console.log('æ²¡æœ‰åŒ¹é…åˆ°è¯­éŸ³');
                heardText.textContent = 'æ²¡å¬æ¸…ï¼Œè¯·ç»§ç»­è¯´...';
            };
            
            recognition.onspeechend = () => {
                console.log('æ£€æµ‹åˆ°è¯­éŸ³ç»“æŸ');
            };
        } else {
            // ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«
            voiceModeBtn.disabled = true;
            voiceNote.textContent = 'âš ï¸ ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Safari';
            voiceNote.style.color = '#ff6b6b';
        }
        
        // è°ƒè¯•é¢æ¿
        const debugPanel = document.getElementById('debugPanel');
        const debugLog = document.getElementById('debugLog');
        let debugLines = [];
        
        function debug(msg) {
            const time = new Date().toLocaleTimeString();
            debugLines.push(`[${time}] ${msg}`);
            if (debugLines.length > 20) debugLines.shift();
            debugLog.innerHTML = debugLines.join('<br>');
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(msg);
        }
        
        // æ¨¡ç³ŠåŒ¹é…å‡½æ•° - å®¹å¿è¯­éŸ³è¯†åˆ«è¯¯å·®
        let lastMatchTime = 0;
        
        // è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦ (0-1)
        function similarity(s1, s2) {
            if (s1.length === 0 || s2.length === 0) return 0;
            
            let matches = 0;
            const len = Math.min(s1.length, s2.length);
            
            for (let i = 0; i < len; i++) {
                if (s1[i] === s2[i]) matches++;
            }
            
            // ä¹Ÿæ£€æŸ¥æ˜¯å¦æœ‰è¿ç»­3å­—åŒ¹é…ï¼ˆä½ç½®ä¸è¦æ±‚å¯¹é½ï¼‰
            for (let i = 0; i <= s1.length - 3; i++) {
                const chunk = s1.slice(i, i + 3);
                if (s2.includes(chunk)) {
                    matches += 2; // é¢å¤–å¥–åŠ±
                    break;
                }
            }
            
            return matches / Math.max(s1.length, s2.length);
        }
        
        function findAndScrollToPosition(transcript) {
            const now = Date.now();
            const timeSinceLast = now - lastMatchTime;
            
            // é˜²æŠ–ï¼šè‡³å°‘é—´éš”0.5ç§’æ‰èƒ½æ»šåŠ¨ï¼ˆå¿«è¯­é€Ÿå‹å¥½ï¼‰
            if (timeSinceLast < 500) {
                debug(`â³ é˜²æŠ–ä¸­ (${Math.round(timeSinceLast)}ms < 500ms)`);
                return;
            }
            
            // æ¸…ç†æ–‡æœ¬
            const cleanTranscript = transcript.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€,.\s\nÂ·~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”+=\[\]{}|;:'",.<>/?Â·""'']/g, '');
            if (cleanTranscript.length < 6) {
                debug(`âš ï¸ æ–‡æœ¬å¤ªçŸ­: ${cleanTranscript.length}å­—`);
                return;
            }
            
            debug(`ğŸ“ å½“å‰è¡Œ=${currentLineIndex}, è¯†åˆ«="${cleanTranscript.slice(-15)}"`);
            
            // æ‰¾ä¸‹ä¸€ä¸ªéç©ºè¡Œ
            let targetLine = currentLineIndex + 1;
            while (targetLine < scriptLines.length && (!scriptLines[targetLine] || !scriptLines[targetLine].trim())) {
                targetLine++;
            }
            if (targetLine >= scriptLines.length) {
                debug(`âš ï¸ å·²æ˜¯æœ€åä¸€è¡Œ`);
                return;
            }
            
            const lineText = scriptLines[targetLine];
            const lineClean = lineText.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€,.\s\nÂ·~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”+=\[\]{}|;:'",.<>/?Â·""'']/g, '');
            if (lineClean.length < 4) {
                debug(`âš ï¸ ç›®æ ‡è¡Œå¤ªçŸ­`);
                return;
            }
            
            // æ–¹æ³•1: æå‰è§¦å‘ - æ£€æµ‹å€’æ•°ç¬¬6åˆ°ç¬¬3ä¸ªå­—ï¼ˆæ›´æ—©è§¦å‘ï¼‰
            const currentText = scriptLines[currentLineIndex] || '';
            const currentClean = currentText.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€,.\s\nÂ·~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”+=\[\]{}|;:'",.<>/?Â·""'']/g, '');
            if (currentClean.length >= 6) {
                // æ£€æŸ¥å€’æ•°6-3ä½ç½®çš„3ä¸ªå­—ï¼ˆæå‰è§¦å‘ï¼‰
                const earlyTrigger = currentClean.slice(-6, -3);
                if (earlyTrigger.length === 3 && cleanTranscript.includes(earlyTrigger)) {
                    debug(`âœ… æå‰è§¦å‘! "${earlyTrigger}" åœ¨è¯†åˆ«æ–‡æœ¬ä¸­`);
                    lastMatchTime = now;
                    scrollToLine(targetLine);
                    return;
                }
                // æ£€æŸ¥å€’æ•°9-6ä½ç½®ï¼ˆæ›´æ—©ï¼‰
                if (currentClean.length >= 9) {
                    const veryEarlyTrigger = currentClean.slice(-9, -6);
                    if (veryEarlyTrigger.length === 3 && cleanTranscript.includes(veryEarlyTrigger)) {
                        debug(`âœ… è¶…å‰è§¦å‘! "${veryEarlyTrigger}" åœ¨è¯†åˆ«æ–‡æœ¬ä¸­`);
                        lastMatchTime = now;
                        scrollToLine(targetLine);
                        return;
                    }
                }
            }
            
            // æ–¹æ³•2: æ£€æŸ¥ä¸‹ä¸€è¡Œçš„ä»»æ„éƒ¨åˆ†ï¼ˆä¸åªæ˜¯å¼€å¤´ï¼‰
            debug(`ğŸ” æ£€æŸ¥è¡Œ${targetLine}çš„ä»»æ„ç‰‡æ®µåœ¨"...${cleanTranscript.slice(-15)}"`);
            
            // ç”Ÿæˆä¸‹ä¸€è¡Œçš„å¤šä¸ª3å­—ç‰‡æ®µ
            for (let i = 0; i <= lineClean.length - 3; i++) {
                const chunk = lineClean.slice(i, i + 3);
                if (cleanTranscript.includes(chunk)) {
                    debug(`âœ… åŒ¹é…! "${chunk}" åœ¨è¯†åˆ«æ–‡æœ¬ä¸­`);
                    lastMatchTime = now;
                    scrollToLine(targetLine);
                    return;
                }
            }
            
            debug(`âŒ æ— åŒ¹é…`);
        }
        
        // æ»šåŠ¨åˆ°æŒ‡å®šè¡Œ
        function scrollToLine(lineIndex) {
            if (lineIndex < currentLineIndex) {
                debug(`ğŸš« scrollToLine(${lineIndex}) æ‹’ç»: å°äºå½“å‰${currentLineIndex}`);
                return;
            }
            if (lineIndex === currentLineIndex) {
                debug(`ğŸš« scrollToLine(${lineIndex}) æ‹’ç»: å·²åœ¨æ­¤è¡Œ`);
                return;
            }
            
            debug(`ğŸ“œ scrollToLine(${lineIndex}) æ‰§è¡Œ! ä»${currentLineIndex}è·³åˆ°${lineIndex}`);
            currentLineIndex = lineIndex;
            
            // æ›´æ–°é«˜äº®
            const paragraphs = textContent.querySelectorAll('p');
            paragraphs.forEach((p, i) => {
                p.classList.remove('current', 'spoken');
                if (i < lineIndex) {
                    p.classList.add('spoken');
                } else if (i === lineIndex) {
                    p.classList.add('current');
                }
            });
            
            // æ»šåŠ¨åˆ°è¯¥è¡Œ - ä½¿ç”¨ getBoundingClientRect ç¡®ä¿åœ¨æ‰‹æœºä¸Šä¹Ÿå‡†ç¡®
            const targetP = paragraphs[lineIndex];
            if (targetP) {
                const rect = targetP.getBoundingClientRect();
                const viewportCenter = window.innerHeight * 0.35;
                const targetCenter = rect.top + rect.height / 2;
                const adjustment = targetCenter - viewportCenter;
                
                debug(`ğŸ“ æ»šåŠ¨è®¡ç®—: ç›®æ ‡ä¸­å¿ƒ=${Math.round(targetCenter)}, å±å¹•ä¸­å¿ƒ=${Math.round(viewportCenter)}, è°ƒæ•´=${Math.round(adjustment)}`);
                
                scrollPosition -= adjustment;
                updateTransform();
            }
        }
        
        function updateTransform() {
            const transform = isMirrored 
                ? `translateY(${scrollPosition}px) scaleX(-1)` 
                : `translateY(${scrollPosition}px)`;
            textContent.style.transform = transform;
        }
        
        function startVoiceRecognition() {
            if (!recognition) {
                heardText.textContent = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«';
                voiceIndicator.classList.add('active');
                return;
            }
            
            isVoiceActive = true;
            voiceIndicator.classList.add('active');
            voiceBtn.classList.add('voice-active');
            playPauseBtn.style.display = 'none';
            voiceBtn.style.display = 'flex';
            speedAdjustBar.style.display = 'none';
            heardText.textContent = 'å¯åŠ¨ä¸­...ç‚¹å‡»å…è®¸éº¦å…‹é£';
            
            // è°ƒè¯•é¢æ¿å·²å…³é—­
            // debugPanel.style.display = 'block';
            // debugLines = [];
            // debug(`ğŸ¤ è¯­éŸ³è¯†åˆ«å¯åŠ¨, å½“å‰è¡Œ=${currentLineIndex}`);
            
            // 3ç§’åå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼Œæ˜¾ç¤ºæç¤º
            const startTimeout = setTimeout(() => {
                if (heardText.textContent.includes('å¯åŠ¨ä¸­')) {
                    heardText.textContent = 'âš ï¸ è¯·åœ¨å¼¹çª—ä¸­å…è®¸éº¦å…‹é£ï¼Œæˆ–æ£€æŸ¥ è®¾ç½®â†’Safariâ†’éº¦å…‹é£';
                }
            }, 3000);
            
            try {
                recognition.start();
                console.log('recognition.start() å·²è°ƒç”¨');
            } catch(e) {
                clearTimeout(startTimeout);
                console.log('å¯åŠ¨é”™è¯¯:', e);
                heardText.textContent = 'âŒ é”™è¯¯: ' + e.message;
            }
        }
        
        function stopVoiceRecognition() {
            if (!recognition) return;
            isVoiceActive = false;
            voiceIndicator.classList.remove('active');
            voiceBtn.classList.remove('voice-active');
            
            try {
                recognition.stop();
            } catch(e) {}
        }
        
        // æ¸…ç©ºæŒ‰é’®
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('scriptText').value = '';
            document.getElementById('scriptText').focus();
        });
        
        // è®¾ç½®äº‹ä»¶
        document.getElementById('fontSize').addEventListener('input', (e) => {
            fontSize = e.target.value;
            document.getElementById('fontSizeValue').textContent = fontSize + 'px';
        });
        
        document.getElementById('scrollSpeed').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = speed;
            currentSpeedEl.textContent = speed;
        });
        
        // æ»šåŠ¨æ¨¡å¼é€‰æ‹©
        document.querySelectorAll('[data-scroll-mode]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                document.querySelectorAll('[data-scroll-mode]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                scrollMode = btn.dataset.scrollMode;
                
                // è¯­éŸ³æ¨¡å¼ä¸‹éšè—é€Ÿåº¦æ§åˆ¶
                speedControl.style.display = scrollMode === 'voice' ? 'none' : 'block';
            });
        });
        
        // å€’è®¡æ—¶é€‰æ‹©
        document.querySelectorAll('[data-countdown]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-countdown]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                countdownSeconds = parseInt(btn.dataset.countdown);
            });
        });
        
        // é•œåƒé€‰æ‹©
        document.querySelectorAll('[data-mirror]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-mirror]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                isMirrored = btn.dataset.mirror === 'true';
            });
        });
        
        // ç›¸æœºé€‰æ‹©
        document.querySelectorAll('[data-camera]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-camera]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                cameraEnabled = btn.dataset.camera === 'true';
            });
        });
        
        // ç›¸æœºæ§åˆ¶å‡½æ•°
        const cameraPreview = document.getElementById('cameraPreview');
        
        async function startCamera() {
            if (!cameraEnabled) return;
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: true  // éœ€è¦éŸ³é¢‘ç”¨äºå½•åˆ¶
                });
                cameraPreview.srcObject = cameraStream;
                cameraPreview.style.display = 'block';
                // ç›¸æœºç”»é¢é•œåƒï¼ˆè‡ªæ‹æ¨¡å¼ï¼‰
                cameraPreview.style.transform = 'scaleX(-1)';
                // æ–‡å­—åŠé€æ˜ä»¥ä¾¿çœ‹æ¸…èƒŒæ™¯
                textContent.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8), -2px -2px 4px rgba(0,0,0,0.8)';
                teleprompter.style.background = 'transparent';
                // æ˜¾ç¤ºå½•åˆ¶æŒ‰é’®
                recordBtn.style.display = 'flex';
            } catch (e) {
                console.error('ç›¸æœºè®¿é—®å¤±è´¥:', e);
                alert('æ— æ³•è®¿é—®ç›¸æœºï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
        
        function stopCamera() {
            if (isRecording) {
                stopRecording();
            }
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraPreview.style.display = 'none';
            cameraPreview.srcObject = null;
            textContent.style.textShadow = '';
            teleprompter.style.background = '';
            recordBtn.style.display = 'none';
        }
        
        // å½•åˆ¶åŠŸèƒ½
        const recordCanvas = document.getElementById('recordCanvas');
        const recordCtx = recordCanvas.getContext('2d');
        const recordBtn = document.getElementById('recordBtn');
        const recordIndicator = document.getElementById('recordIndicator');
        
        function startRecording() {
            if (!cameraStream || isRecording) return;
            
            // è®¾ç½® canvas å°ºå¯¸
            recordCanvas.width = cameraPreview.videoWidth || 1280;
            recordCanvas.height = cameraPreview.videoHeight || 720;
            
            // å¼€å§‹ç»˜åˆ¶å¾ªç¯
            function drawFrame() {
                if (!isRecording) return;
                
                // ç»˜åˆ¶è§†é¢‘å¸§ï¼ˆé•œåƒï¼‰
                recordCtx.save();
                recordCtx.scale(-1, 1);
                recordCtx.drawImage(cameraPreview, -recordCanvas.width, 0, recordCanvas.width, recordCanvas.height);
                recordCtx.restore();
                
                // ç»˜åˆ¶æ–‡å­—
                const lines = textContent.querySelectorAll('p');
                const centerY = recordCanvas.height * 0.35;
                recordCtx.font = `bold ${fontSize * 1.5}px -apple-system, sans-serif`;
                recordCtx.textAlign = 'center';
                recordCtx.fillStyle = '#fff';
                recordCtx.shadowColor = 'rgba(0,0,0,0.8)';
                recordCtx.shadowBlur = 10;
                
                lines.forEach((line, i) => {
                    if (line.classList.contains('current')) {
                        recordCtx.fillStyle = '#ff6b9d';
                        const lineY = centerY;
                        recordCtx.fillText(line.textContent, recordCanvas.width / 2, lineY);
                    }
                });
                
                recordCtx.shadowBlur = 0;
                recordingAnimationId = requestAnimationFrame(drawFrame);
            }
            
            // è·å– canvas æµ
            canvasStream = recordCanvas.captureStream(30);
            
            // æ·»åŠ éŸ³é¢‘è½¨é“ï¼ˆå¦‚æœæœ‰ï¼‰
            if (cameraStream.getAudioTracks().length > 0) {
                canvasStream.addTrack(cameraStream.getAudioTracks()[0]);
            }
            
            // åˆ›å»º MediaRecorder - é€‰æ‹©å…¼å®¹æ ¼å¼
            recordedChunks = [];
            // æ£€æµ‹æ”¯æŒçš„æ ¼å¼ï¼ˆä¼˜å…ˆ mp4ï¼‰
            const formats = [
                'video/mp4;codecs=avc1',
                'video/mp4',
                'video/webm;codecs=h264',
                'video/webm;codecs=vp8,opus',
                'video/webm;codecs=vp9',
                'video/webm'
            ];
            let mimeType = '';
            for (const fmt of formats) {
                if (MediaRecorder.isTypeSupported(fmt)) {
                    mimeType = fmt;
                    break;
                }
            }
            if (!mimeType) {
                alert('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘å½•åˆ¶');
                return;
            }
            const isWebm = mimeType.includes('webm');
            console.log('ä½¿ç”¨å½•åˆ¶æ ¼å¼:', mimeType, isWebm ? '(éœ€è¦è½¬æ¢æ‰èƒ½åœ¨iOSæ‰“å¼€)' : '');
            mediaRecorder = new MediaRecorder(canvasStream, { mimeType });
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };
            
            mediaRecorder.onstop = async () => {
                const actualMimeType = mediaRecorder.mimeType || 'video/mp4';
                const blob = new Blob(recordedChunks, { type: actualMimeType });
                const ext = actualMimeType.includes('mp4') ? 'mp4' : 'webm';
                
                // å°è¯•ä½¿ç”¨ Web Share APIï¼ˆiOS æ”¯æŒï¼‰
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], `video.${ext}`, { type: actualMimeType })] })) {
                    try {
                        const file = new File([blob], `teleprompter-${Date.now()}.${ext}`, { type: actualMimeType });
                        await navigator.share({
                            files: [file],
                            title: 'æè¯å™¨å½•åˆ¶',
                            text: 'æˆ‘çš„æè¯å™¨å½•åˆ¶è§†é¢‘'
                        });
                        return;
                    } catch (e) {
                        console.log('åˆ†äº«å–æ¶ˆæˆ–å¤±è´¥:', e);
                    }
                }
                
                // åå¤‡æ–¹æ¡ˆï¼šæ˜¾ç¤ºè§†é¢‘é¢„è§ˆ + ä¸‹è½½/åˆ†äº«æŒ‰é’®
                const url = URL.createObjectURL(blob);
                const filename = `teleprompter-${Date.now()}.${ext}`;
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;';
                modal.innerHTML = `
                    <p style="color:#fff;margin-bottom:10px;text-align:center;">ğŸ¬ å½•åˆ¶å®Œæˆï¼</p>
                    <video src="${url}" controls playsinline style="max-width:100%;max-height:50vh;border-radius:10px;"></video>
                    <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;justify-content:center;">
                        <a href="${url}" download="${filename}" style="padding:15px 30px;font-size:16px;border:none;border-radius:10px;background:#4CAF50;color:#fff;text-decoration:none;">ğŸ“¥ ä¸‹è½½è§†é¢‘</a>
                        <button id="shareVideoBtn" style="padding:15px 30px;font-size:16px;border:none;border-radius:10px;background:#2196F3;color:#fff;">ğŸ“¤ åˆ†äº«</button>
                        <button onclick="this.closest('div').parentElement.remove()" style="padding:15px 30px;font-size:16px;border:none;border-radius:10px;background:#ff6b9d;color:#fff;">âœ• å…³é—­</button>
                    </div>
                    <p style="color:#888;margin-top:15px;font-size:12px;text-align:center;">iOSç”¨æˆ·ï¼šé•¿æŒ‰è§†é¢‘å¯ä¿å­˜åˆ°ç›¸å†Œ</p>
                    ${ext === 'webm' ? '<p style="color:#ffcc00;margin-top:10px;font-size:12px;text-align:center;">âš ï¸ WebMæ ¼å¼iPhoneæ— æ³•ç›´æ¥æ’­æ”¾<br>æ¨èç”¨ <a href="https://cloudconvert.com/webm-to-mp4" target="_blank" style="color:#4CAF50;">CloudConvert</a> è½¬æ¢ä¸ºMP4</p>' : ''}
                    ${ext === 'webm' ? '<p style="color:#888;margin-top:5px;font-size:11px;text-align:center;">ğŸ’¡ æˆ–ä½¿ç”¨Chromeæµè§ˆå™¨å½•åˆ¶å¯å¾—åˆ°æ›´å¥½çš„å…¼å®¹æ€§</p>' : ''}
                `;
                document.body.appendChild(modal);
                
                // åˆ†äº«æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                modal.querySelector('#shareVideoBtn').onclick = async () => {
                    if (navigator.share) {
                        try {
                            const file = new File([blob], filename, { type: actualMimeType });
                            await navigator.share({ files: [file], title: 'æè¯å™¨å½•åˆ¶' });
                        } catch (e) {
                            alert('åˆ†äº«å–æ¶ˆæˆ–ä¸æ”¯æŒ');
                        }
                    } else {
                        alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«åŠŸèƒ½');
                    }
                };
            };
            
            isRecording = true;
            mediaRecorder.start();
            drawFrame();
            recordBtn.textContent = 'â¹';
            recordBtn.style.background = '#44ff44';
            recordIndicator.style.display = 'block';
        }
        
        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;
            cancelAnimationFrame(recordingAnimationId);
            mediaRecorder.stop();
            recordBtn.textContent = 'âº';
            recordBtn.style.background = '#ff4444';
            recordIndicator.style.display = 'none';
        }
        
        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });
        
        // å¼€å§‹
        document.getElementById('startBtn').addEventListener('click', async () => {
            const text = document.getElementById('scriptText').value.trim();
            if (!text) {
                alert('è¯·å…ˆè¾“å…¥æ–‡æ¡ˆï¼');
                return;
            }
            
            // å¦‚æœæ˜¯è¯­éŸ³æ¨¡å¼ï¼Œå…ˆåœ¨ç”¨æˆ·ç‚¹å‡»æ—¶è¯·æ±‚æƒé™
            if (scrollMode === 'voice' && recognition) {
                try {
                    // å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»äº‹ä»¶ä¸­ç›´æ¥å¯åŠ¨
                    recognition.start();
                    recognition.stop(); // ç«‹å³åœæ­¢ï¼Œåªæ˜¯ä¸ºäº†è§¦å‘æƒé™è¯·æ±‚
                    await new Promise(r => setTimeout(r, 500)); // ç­‰å¾…æƒé™å¼¹çª—
                } catch(e) {
                    console.log('é¢„å¯åŠ¨:', e.message);
                }
            }
            
            // ä¿å­˜è„šæœ¬è¡Œï¼ˆä¿ç•™ç©ºè¡Œä»¥å¯¹é½æ®µè½ç´¢å¼•ï¼‰
            scriptLines = text.split('\n');
            allText = text;
            currentLineIndex = 0;
            lastMatchTime = 0; // é‡ç½®åŒ¹é…æ—¶é—´
            
            // è®©è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ï¼Œç¡®ä¿ä»å¤´å¼€å§‹
            document.getElementById('scriptText').blur();
            
            // è®¾ç½®æ–‡æœ¬
            textContent.innerHTML = text.split('\n').map((line, i) => 
                line ? `<p style="margin: 0.5em 0;" data-line="${i}">${line}</p>` : '<p style="margin: 0.5em 0;">&nbsp;</p>'
            ).join('');
            textContent.style.fontSize = fontSize + 'px';
            
            // é•œåƒç”± updateTransform() å¤„ç†
            
            // é«˜äº®ç¬¬ä¸€è¡Œï¼Œå¹¶æŠŠç¬¬ä¸€è¡Œå®šä½åˆ°å±å¹•ä¸­å¤®
            setTimeout(() => {
                const firstP = textContent.querySelector('p');
                if (firstP) {
                    firstP.classList.add('current');
                    // åˆå§‹åŒ–æ—¶ scrollPosition=0ï¼Œç›´æ¥è®¡ç®—è°ƒæ•´é‡
                    scrollPosition = 0;
                    const rect = firstP.getBoundingClientRect();
                    const viewportCenter = window.innerHeight * 0.35;
                    const targetCenter = rect.top + rect.height / 2;
                    scrollPosition = viewportCenter - targetCenter;
                    updateTransform();
                }
            }, 150);
            
            // è®¾ç½®æ§åˆ¶æ 
            if (scrollMode === 'voice') {
                playPauseBtn.style.display = 'none';
                voiceBtn.style.display = 'flex';
                speedAdjustBar.style.display = 'none';
            } else {
                playPauseBtn.style.display = 'flex';
                voiceBtn.style.display = 'none';
                speedAdjustBar.style.display = 'flex';
            }
            
            settingsPanel.classList.add('hidden');
            teleprompter.classList.add('active');
            
            // å¯åŠ¨ç›¸æœºï¼ˆå¦‚æœå¼€å¯ï¼‰
            if (cameraEnabled) {
                startCamera();
            }
            
            // å€’è®¡æ—¶
            if (countdownSeconds > 0) {
                startCountdown();
            } else {
                if (scrollMode === 'voice') {
                    startVoiceRecognition();
                } else {
                    startScrolling();
                }
            }
        });
        
        function startCountdown() {
            let count = countdownSeconds;
            countdown.classList.add('active');
            countdown.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countdown.textContent = count;
                } else {
                    clearInterval(timer);
                    countdown.classList.remove('active');
                    if (scrollMode === 'voice') {
                        startVoiceRecognition();
                    } else {
                        startScrolling();
                    }
                }
            }, 1000);
        }
        
        function startScrolling() {
            isPlaying = true;
            playPauseBtn.textContent = 'â¸ï¸';
            scroll();
        }
        
        function scroll() {
            if (!isPlaying) return;
            
            scrollPosition -= speed / 60;
            updateTransform();
            
            // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨å®Œæ¯•
            const textHeight = textContent.offsetHeight;
            if (scrollPosition < -textHeight) {
                isPlaying = false;
                playPauseBtn.textContent = 'â–¶ï¸';
                return;
            }
            
            animationId = requestAnimationFrame(scroll);
        }
        
        // æ’­æ”¾/æš‚åœ
        playPauseBtn.addEventListener('click', () => {
            if (isPlaying) {
                isPlaying = false;
                playPauseBtn.textContent = 'â–¶ï¸';
                cancelAnimationFrame(animationId);
            } else {
                startScrolling();
            }
        });
        
        // è¯­éŸ³æŒ‰é’®åˆ‡æ¢
        voiceBtn.addEventListener('click', () => {
            if (isVoiceActive) {
                stopVoiceRecognition();
            } else {
                startVoiceRecognition();
            }
        });
        
        // é€Ÿåº¦è°ƒèŠ‚
        document.getElementById('speedUp').addEventListener('click', () => {
            speed = Math.min(100, speed + 5);
            currentSpeedEl.textContent = speed;
        });
        
        document.getElementById('speedDown').addEventListener('click', () => {
            speed = Math.max(10, speed - 5);
            currentSpeedEl.textContent = speed;
        });
        
        // é‡ç½®
        document.getElementById('resetBtn').addEventListener('click', () => {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            currentLineIndex = 0;
            lastMatchTime = 0; // é‡ç½®åŒ¹é…æ—¶é—´
            playPauseBtn.textContent = 'â–¶ï¸';
            
            // æ¸…é™¤é«˜äº®å¹¶é‡æ–°å®šä½åˆ°ç¬¬ä¸€è¡Œ
            const paragraphs = textContent.querySelectorAll('p');
            paragraphs.forEach((p, i) => {
                p.classList.remove('current', 'spoken');
                if (i === 0) p.classList.add('current');
            });
            
            // é‡æ–°è®¡ç®—ç¬¬ä¸€è¡Œå±…ä¸­ä½ç½® - ç›´æ¥ä»å½“å‰ä½ç½®è°ƒæ•´
            const firstP = paragraphs[0];
            if (firstP) {
                const rect = firstP.getBoundingClientRect();
                const viewportCenter = window.innerHeight * 0.35;
                const targetCenter = rect.top + rect.height / 2;
                const adjustment = targetCenter - viewportCenter;
                scrollPosition -= adjustment;
                updateTransform();
                
                debug(`ğŸ”„ Reset: è°ƒæ•´=${Math.round(adjustment)}, æ–°scrollPosition=${Math.round(scrollPosition)}`);
            }
        });
        
        // è¿”å›è®¾ç½®
        document.getElementById('backBtn').addEventListener('click', () => {
            exitPrompter();
        });
        
        document.getElementById('exitBtn').addEventListener('click', () => {
            exitPrompter();
        });
        
        function exitPrompter() {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            stopVoiceRecognition();
            stopCamera();
            teleprompter.classList.remove('active');
            settingsPanel.classList.remove('hidden');
        }
        
        // è§¦æ‘¸æ§åˆ¶ï¼ˆç‚¹å‡»å±å¹•æš‚åœ/ç»§ç»­ï¼‰- ä»…è‡ªåŠ¨æ¨¡å¼
        document.querySelector('.prompter-text').addEventListener('click', () => {
            if (scrollMode === 'auto') {
                if (isPlaying) {
                    isPlaying = false;
                    playPauseBtn.textContent = 'â–¶ï¸';
                    cancelAnimationFrame(animationId);
                } else {
                    startScrolling();
                }
            }
        });
        
        // é˜²æ­¢iOSæ©¡çš®ç­‹æ•ˆæœ
        document.body.addEventListener('touchmove', (e) => {
            if (teleprompter.classList.contains('active')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (!teleprompter.classList.contains('active')) return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    if (scrollMode === 'auto') {
                        if (isPlaying) {
                            isPlaying = false;
                            playPauseBtn.textContent = 'â–¶ï¸';
                            cancelAnimationFrame(animationId);
                        } else {
                            startScrolling();
                        }
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    speed = Math.min(100, speed + 5);
                    currentSpeedEl.textContent = speed;
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    speed = Math.max(10, speed - 5);
                    currentSpeedEl.textContent = speed;
                    break;
                case 'KeyR':
                    e.preventDefault();
                    document.getElementById('resetBtn').click();
                    break;
                case 'Escape':
                    e.preventDefault();
                    exitPrompter();
                    break;
            }
        });
        
        // è‡ªåŠ¨æ»šåŠ¨æ¨¡å¼ä¸‹ä¹Ÿæ›´æ–°å½“å‰è¡Œé«˜äº®
        function updateCurrentLineHighlight() {
            if (scrollMode !== 'auto' || !isPlaying) return;
            
            const paragraphs = textContent.querySelectorAll('p');
            const centerY = window.innerHeight * 0.35;
            
            paragraphs.forEach((p, i) => {
                const rect = p.getBoundingClientRect();
                const pCenter = rect.top + rect.height / 2;
                
                p.classList.remove('current', 'spoken');
                if (Math.abs(pCenter - centerY) < rect.height) {
                    p.classList.add('current');
                    currentLineIndex = i;
                } else if (rect.bottom < centerY) {
                    p.classList.add('spoken');
                }
            });
            
            if (isPlaying) {
                requestAnimationFrame(updateCurrentLineHighlight);
            }
        }
        
        // ä¿®æ”¹ startScrolling å¯åŠ¨é«˜äº®æ›´æ–°
        const originalStartScrolling = startScrolling;
        startScrolling = function() {
            originalStartScrolling();
            if (scrollMode === 'auto') {
                updateCurrentLineHighlight();
            }
        };
        
        // ä¿å­˜è®¾ç½®åˆ° localStorage
        function saveSettings() {
            localStorage.setItem('teleprompter-settings', JSON.stringify({
                fontSize, speed, countdownSeconds, isMirrored, scrollMode
            }));
        }
        
        // åŠ è½½è®¾ç½®
        function loadSettings() {
            try {
                const saved = JSON.parse(localStorage.getItem('teleprompter-settings'));
                if (saved) {
                    fontSize = saved.fontSize || 42;
                    speed = saved.speed || 40;
                    countdownSeconds = saved.countdownSeconds ?? 3;
                    isMirrored = saved.isMirrored || false;
                    scrollMode = saved.scrollMode || 'auto';
                    
                    // æ›´æ–° UI
                    document.getElementById('fontSize').value = fontSize;
                    document.getElementById('fontSizeValue').textContent = fontSize + 'px';
                    document.getElementById('scrollSpeed').value = speed;
                    document.getElementById('speedValue').textContent = speed;
                    currentSpeedEl.textContent = speed;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.querySelectorAll('[data-countdown]').forEach(b => {
                        b.classList.toggle('active', parseInt(b.dataset.countdown) === countdownSeconds);
                    });
                    document.querySelectorAll('[data-mirror]').forEach(b => {
                        b.classList.toggle('active', (b.dataset.mirror === 'true') === isMirrored);
                    });
                    document.querySelectorAll('[data-scroll-mode]').forEach(b => {
                        b.classList.toggle('active', b.dataset.scrollMode === scrollMode);
                    });
                    speedControl.style.display = scrollMode === 'voice' ? 'none' : 'block';
                }
            } catch(e) {}
        }
        
        // è®¾ç½®å˜åŒ–æ—¶ä¿å­˜
        ['fontSize', 'scrollSpeed'].forEach(id => {
            document.getElementById(id).addEventListener('change', saveSettings);
        });
        document.querySelectorAll('[data-countdown], [data-mirror], [data-scroll-mode]').forEach(btn => {
            btn.addEventListener('click', () => setTimeout(saveSettings, 100));
        });
        
        // é¡µé¢åŠ è½½æ—¶æ¢å¤è®¾ç½®
        loadSettings();
        
        // ========== æ–°åŠŸèƒ½: å±å¹•å¸¸äº® ==========
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('å±å¹•å¸¸äº®å·²å¯ç”¨');
                    wakeLock.addEventListener('release', () => {
                        console.log('å±å¹•å¸¸äº®å·²é‡Šæ”¾');
                    });
                } catch (e) {
                    console.log('å±å¹•å¸¸äº®è¯·æ±‚å¤±è´¥:', e);
                }
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }
        
        // ========== æ–°åŠŸèƒ½: è¿›åº¦æ¡ + è®¡æ—¶å™¨ ==========
        const progressBar = document.getElementById('progressBar');
        const timerDisplay = document.getElementById('timerDisplay');
        let timerInterval = null;
        
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            requestAnimationFrame(updateProgress);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function resetTimer() {
            stopTimer();
            startTime = null;
            timerDisplay.textContent = '00:00';
            progressBar.style.width = '0%';
        }
        
        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        }
        
        function updateProgress() {
            if (!teleprompter.classList.contains('active')) return;
            
            const textHeight = textContent.offsetHeight;
            const viewportHeight = window.innerHeight;
            const totalScroll = textHeight + viewportHeight;
            const scrolled = viewportHeight / 2 - scrollPosition;
            const progress = Math.min(100, Math.max(0, (scrolled / textHeight) * 100));
            
            progressBar.style.width = progress + '%';
            
            requestAnimationFrame(updateProgress);
        }
        
        // ä¿®æ”¹ startScrolling åŠ å…¥è®¡æ—¶å™¨å’Œå±å¹•å¸¸äº®
        const _originalStart = startScrolling;
        startScrolling = function() {
            _originalStart();
            startTimer();
            requestWakeLock();
        };
        
        // ä¿®æ”¹ exitPrompter é‡Šæ”¾èµ„æº
        const _originalExit = exitPrompter;
        exitPrompter = function() {
            _originalExit();
            stopTimer();
            resetTimer();
            releaseWakeLock();
        };
        
        // ========== æ–°åŠŸèƒ½: ä¸»é¢˜åˆ‡æ¢ ==========
        function setTheme(theme) {
            themes.forEach(t => document.body.classList.remove('theme-' + t));
            document.body.classList.add('theme-' + theme);
            currentTheme = theme;
            
            // ä¿å­˜åˆ°è®¾ç½®
            localStorage.setItem('teleprompter-theme', theme);
            
            // æ˜¾ç¤ºæç¤º
            if (teleprompter.classList.contains('active')) {
                showToast('ğŸ¨ ' + themeNames[theme]);
            }
        }
        
        function nextTheme() {
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            setTheme(themes[nextIndex]);
        }
        
        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        const savedTheme = localStorage.getItem('teleprompter-theme');
        if (savedTheme && themes.includes(savedTheme)) {
            setTheme(savedTheme);
        }
        
        // Toast æç¤º
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: #fff;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 16px;
                z-index: 300;
                animation: fadeInOut 1.5s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1500);
        }
        
        // æ·»åŠ  fadeInOut åŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
                20% { opacity: 1; transform: translateX(-50%) translateY(0); }
                80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0.5; }
            }
        `;
        document.head.appendChild(style);
        
        // æ·»åŠ  T é”®åˆ‡æ¢ä¸»é¢˜åˆ°é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (!teleprompter.classList.contains('active')) return;
            if (e.code === 'KeyT') {
                e.preventDefault();
                nextTheme();
            }
        });
        
        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }
    </script>
</body>
</html>
